secrets:
  server_secrets:
    file: ./server/secrets.json
  keycloak_env:
    file: ./keycloak/.env

volumes:
  proxy_data:
  proxy_config:

services:
  proxy:
    image: caddy:2
    volumes:
      - proxy_data:/data # Certs etc.
      - proxy_config:/config
      - ./proxy/Caddyfile:/etc/caddy/Caddyfile
    ports:
      - 80:80
      - 443:443
      - 443:443/udp
    env_file:
      - ./common/.env
      - ./caddy/.env
    restart: on-failure

  server:
    image: ghcr.io/opencleanenergy/emma:latest
    secrets:
      - source: server_secrets
        target: secrets.json
    env_file:
      - ./common/.env
    restart: on-failure

  keycloak:
    image: ghcr.io/opencleanenergy/keycloak:latest
    command: start
    secrets:
      - source: keycloak_env
        target: .env
    env_file:
      - ./common/.env
    restart: on-failure
